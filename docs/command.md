# AZIR 通信コマンド

<b>通信プロトコル</b><br>
AZIRは赤外線でシリアル通信（UART）のコマンドを送信してキー制御を行います。<br>
UARTは通常時にHIGH、信号送信時にLOWになりますが、AZIRでの送信は電池の消費を減らすため通常時消灯、信号を送る時に点灯とします。<br>
通信速度はデフォルトで800Hzとしていますが、早くしたり遅くしたりする事でそれぞれメリットデメリットがあるため可変で変更できるようにしています。<br>
(AZIR50は800Hz固定のためAZIR50を使用したキーボードは800Hzでしか動作しません。AZSENSORのファームウェア側がAZTOOL上にて変更可能で、自前で赤外線送信側のファームウェアを作成する場合に好きな周波数で作成できます。)<br>
周波数が高いとその分反応速度の速いセンサーや赤外線LEDを使用する必要があります。AZSENSORで使用しているセンサーでは2400Hz程度まで信号を受け取れる事を確認できましたが、その分センサーとの距離が近くでないと受信できず3～5cm程度まで近づかないと受信できませんでした。<br>
キーボード作成者が用途に応じて調節して下さい。<br>

<br>

|  項目  |  周波数が低い  |  周波数が高い  |
|  --  |  --  |  --  |
|  キー入力の反応速度  |  遅い  |  早い  |
|  電池の消費  |  大  |  小  |
|  センサーとの距離  |  遠くも反応  |  近くのみ反応  |


<br><br>

<b>キー入力</b><br>
AZIRではキー番号1～255の仮想的なキーを持ち、仮想キーを押した離したなどの入力状態を制御するコマンドを赤外線で送信してキー入力を行います。<br>
ボタンが押された時に「キーを押す」コマンドの{0xB1,0x01}の2バイトを送信して、ボタンが離された時に「キーを離す」コマンドの{0xB2,0x01}の2バイトを送信すると仮想キー1を押して離すのキー入力ができます。<br>
同じようにして{0xB1,0x02}と{0xB2,0x02}を送信すれば仮想キー2のキー入力ができます。<br>
仮想キーが押された時に実際PCに入力される文字の設定はAZTOOLを使用して設定するため、赤外線でのコマンド送信時に考える必要がありません。<br>

<br><br>

<b>キー押しっぱなしになる問題</b><br>
キーを押すコマンドの送信は成功し、キーを離すコマンドの送信を失敗した場合に押しっぱなしになってしまうので気を付けて下さい。<br>
送信機側は押しっぱなしになっているかどうか測定する事ができないため、対策として定期的に「全てのキーを離す」コマンドの{0xB4}を送信する事をお勧めします。しかしコマンドを送信した分だけ電池を消費するため頻度は低い方が良いです。<br>
キーボードを動かしながら入力したり、入力中にセンサーとの間に障害物が置かれたなどの特殊な場合でない限り送信失敗する事は少ないのでそこまでの頻度で送信する必要は無いと考えています。<br>
開発中の動作確認の時にキーボードの位置を移動しながら使用した時以外で押しっぱなしになってしまった事はありませんでした。<br>
<br>
その他の対策として、1つのコマンドで押すと離すの両方を行う{0xB3}コマンドも用意してあります。1つのコマンドだけで離すも一緒に行うので押しっぱなしなってしまう心配はありません。ただしホールド（押しっぱなし）をすることができません。<br>
このコマンドは離したコマンドを送信しなくてよい分省電力化へも有力です。<br>
手持ちでリモコンのように使用するキーボードを作成する場合に向いています。<br>

<br><br>

<b>マウスの操作</b><br>
AZIRにはマウスを操作するコマンドも用意されています。<br>
マウスの移動は相対位置操作のみで、コマンド{0xB5,0x01,0x00}でマウス位置を右に1ピクセル移動させられます。<br>
同様にコマンド{0xB6,0x01,0x00}でマウスのホイール動作も行えます。<br>

<br><br>

<b>複数端末から同時に信号が送られた時</b><br>
AZSENSORに複数赤外線センサーが付いていますが信号を受け取るロジックは1つのため、複数のキーボードから同時に信号を送信されると入力が行えません。<br>
その場合2つの信号が重なったコマンドと認識するため、コマンドとして認識されないか場合によっては誤入力となってしまう可能性はあります。ただし信号の周波数デフォルトの800Hzでキーを押下した時のコマンド2バイトを送信するのに必要な時間は約0.02秒のため、通常のキーボード操作を行っている分には同時に信号が送られる事はないと考えています。<br>

<br><br>

<b>設定情報送信のコマンド</b><br>
設定情報送信のコマンド{0xB7}はAZIR50のスキャン方式や送信開始キー番号を設定する時に使用するコマンドです。<br>
AZIR50が現在どういう設定なのかをAZSENSORで確認するためだけに使用します。<br>
今後AZIR50以外のキースキャンするボードを作成した時に拡張できるようにするためにデータタイプを送信するようにしています、新しいボードを作成したとしてもデータ長は5バイト固定にしたいと考えています。<br>

<br><br>

## 0xB1　キーを押す

<b>■ 送信 ： 2 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0xB1 (固定)  |  1  |
|  押す仮想キーの番号  |  0x01 ～ 0xFF  |  1  |

<br><br>

## 0xB2　キーを離す

<b>■ 送信 ： 2 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0xB2 (固定)  |  1  |
|  離す仮想キーの番号  |  0x01 ～ 0xFF  |  1  |

<br><br>

## 0xB3　キーを押して離す

<b>■ 送信 ： 2 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0xB3 (固定)  |  1  |
|  押して離す仮想キーの番号  |  0x01 ～ 0xFF  |  1  |

<br><br>

## 0xB4　全てのキーを離す

<b>■ 送信 ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0xB4 (固定)  |  1  |

<br><br>

## 0xB5　マウス移動

<b>■ 送信 ： 3 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0xB5 (固定)  |  1  |
|  移動する X座標  |  char型で -127 ～ 127  |  1  |
|  移動する Y座標  |  char型で -127 ～ 127  |  1  |

<br><br>

## 0xB6　マウスホイール移動

<b>■ 送信 ： 3 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0xB6 (固定)  |  1  |
|  ホイールする X座標  |  char型で -127 ～ 127  |  1  |
|  ホイールする Y座標  |  char型で -127 ～ 127  |  1  |

<br><br>

## 0xB7　AZIR50の設定情報送信

<b>■ 送信 ： 5 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0xB7 (固定)  |  1  |
|  送信データのタイプ  |  0x01 (AZIR50の設定情報)  |  1  |
|  今何を設定中か  |  0x00 = スキャンモード<br>0x01 = 送信開始キー番号設定  |  1  |
|  今設定されている<br>スキャンモード  |  0x00 = マトリックススキャン<br>0x01 = ダブルマトリックススキャン<br>0x02 = ダイレクトスキャン  |  1  |
|  今設定されている<br>送信開始キー番号  |  0x01 ～ 0xFF  |  1  |

<br><br>
